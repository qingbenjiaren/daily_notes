# RocketMQ基本理论及架构

## 一、前置知识

### 链式调用和木桶理论

![](Rocket.assets/木桶理论.png)

### 引入MQ

![](Rocket.assets/引入MQ.png)

## 二、MQ前置知识

### MQ作用

消息队列作为高并发系统的核心组件之一，能够帮助业务系统解耦提升开发效率和系统稳定性。主要具有以下优势

- 削峰填谷（大促等流量洪流突然来袭时，MQ 可以缓冲突发流量，避免下游订阅系统因突发流量崩溃）
- 系统解耦（解决不同重要程序，不同能力级别系统之间依赖导致一死全死）
- 提升性能（当存在一对多调用时，可以发一条消息给消息系统，让消息系统通知相关系统）
- 蓄流压测（线上有些链路不好压测，可以通过堆积一定量消息再放开来压测）

### 应用场景

- 日志监控：作为重要日志的监控通信管道，将应用日志监控对系统性能影响降到最低
- 推送消息：为社交应用和物联网应用提供点对点推送
- 金融报文：发送金融报文，实现金融准实时的报文传输，可靠安全
- 电信信令：将电信信令封装成消息，传递到各个控制终端，实现准实时控制和信息传递。

#### 1、异步处理

场景说明：用户注册后，需要发注册邮件和注册短信。传统的做法有两种：

**串行处理**

1. register ---------------50ms
2. send mail ------------50ms
3. send msg ------------50ms

**并行模式**

1. register ---------------50ms
2. 多线程，线程1send mail -----------50ms，线程2send msg------------50ms

**消息中间件**

1. register ---------------50ms
2. 写入消息队列--------1ms

按照以上约定，用户的响应时间相当于是注册信息写入数据库的时间，也就是 50 毫秒。注册邮件，发送短信写入消息队列后，直接返回，因此写入消息队列的速度很快，基本可以忽略，因此用户的响应时间可能是 50 毫秒。因此架构改变后，系统的吞吐量提高到每秒 20 QPS。比串行提高了 3 倍，比并行提高了两倍。

#### 2、应用解耦

场景说明：用户下单后，订单系统需要通知库存系统。传统的做法是，订单系统调用库存系统的接口。

**传统模式的缺点：**假如库存系统无法访问，则订单减库存将失败，从而导致订单失败，订单系统与库存系统耦合

**引入消息中间件**：

1. 订单系统：用户下单后，订单系统完成持久化处理，将消息写入消息队列，返回用户订单下单成功
2. 库存系统：订阅下单的消息，采用拉/推的方式，获取下单信息，库存系统根据下单信息，进行库存操作

#### 3、流量削峰

1、地铁早高峰

2、高铁春运

**排队，如果所有人都进去了，地铁站和高铁站就瘫痪了**

流量削锋也是消息队列中的常用场景，一般在秒杀或团抢活动中使用广泛。 应用场景：秒杀活动，一般会因为流量过大，导致流量暴增，应用挂掉。为解决这个问题，一般需要在应用前端加入消息队列。

**用户请求------->消息队列<--------秒杀业务处理**

用户的请求，服务器接收后，首先写入消息队列。假如消息队列长度超过最大数量，则直接抛弃用户请求或跳转到错误页面。 秒杀业务根据消息队列中的请求信息，再做后续处理

#### 4、日志处理

日志处理是指将消息队列用在日志处理中，比如 Kafka 的应用，解决大量日志传输的问题。架构简化如下

日志采集客户端 -------->KAFKA消息队列<--------日志处理应用

日志采集客户端，负责日志数据采集，定时写受写入 Kafka 队列， Kafka 消息队列，负责日志数据的接收，存储和转发 日志处理应用：订阅并消费 kafka 队列中的日志数据

#### 5、消息通讯

消息通讯是指，消息队列一般都内置了高效的通信机制，因此也可以用在纯的消息通讯。比如实现点对点消息队列，或者聊天室等 点对点通讯：

客户端 A ----------->消息队列<-----------客户端B

聊天室通讯

​                ----------->消息队列<-----------

客户端 A                                                客户端B

​                < -----------消息队列----------->

客户端 A，客户端 B，客户端 N 订阅同一主题，进行消息发布和接收。实现类似聊天室效果。

以上实际是消息队列的两种消息模式，点对点或发布订阅模式。

### 示例

#### 电商系统

![](Rocket.assets/电商系统示例.png)

消息队列采用高可用，可持久化的消息中间件。比如 Active MQ，Rabbit MQ，RocketMq。

#### 日志收集系统

![](Rocket.assets/日志收集系统示例.png)

#### 事务处理

![](Rocket.assets/事务处理.png)